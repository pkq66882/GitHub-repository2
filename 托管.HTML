<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>GitHub 文件管理器</title>
    <script src="https://cdn.tailwindcss.com/3.3.3"></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.7.2/css/all.min.css">
</head>
<body class="min-h-screen p-4 md:p-6">
    <!-- 认证界面 -->
    <div id="auth-screen" class="flex flex-col items-center justify-center min-h-screen">
        <!-- ... existing auth screen content ... -->
    </div>
    
    <!-- 主界面 -->
    <div id="main-screen" class="hidden flex-col h-full max-w-6xl mx-auto w-full">
        <!-- 顶部导航栏 -->
        <div class="top-nav glass-panel flex items-center p-4 mb-4">
            <!-- ... existing top nav content ... -->
        </div>

        <!-- 文件列表区域 -->
        <div class="flex-1 overflow-y-auto">
            <!-- ... existing file list content ... -->
        </div>
        
        <!-- 底部工具栏 -->
        <div id="toolbar" class="fixed bottom-6 left-1/2 transform -translate-x-1/2 flex gap-3 p-3 toolbar">
            <!-- ... existing toolbar buttons ... -->
            <button id="static-site-btn" class="glass-btn p-3 hidden" title="托管静态网站">
                <i class="fas fa-globe text-green-500"></i>
            </button>
        </div>

        <!-- 批量操作工具栏 -->
        <div id="batch-toolbar" class="batch-toolbar">
            <!-- ... existing batch toolbar content ... -->
        </div>
    </div>
    
    <!-- 操作提示 -->
    <div id="toast" class="fixed bottom-20 left-1/2 transform -translate-x-1/2 glass-panel px-6 py-3 rounded-full opacity-0 transition-opacity duration-300 text-sm font-medium">
        <!-- 提示内容 -->
    </div>
    
    <!-- 确认对话框 -->
    <div id="confirm-dialog" class="fixed inset-0 z-50 dialog-overlay flex items-center justify-center p-4 opacity-0 pointer-events-none transition-opacity duration-300">
        <!-- ... existing confirm dialog ... -->
    </div>
    
    <!-- 新建文件夹对话框 -->
    <div id="new-folder-dialog" class="fixed inset-0 z-50 dialog-overlay flex items-center justify-center p-4 opacity-0 pointer-events-none transition-opacity duration-300">
        <!-- ... existing new folder dialog ... -->
    </div>
    
    <!-- 新建仓库对话框 -->
    <div id="new-repo-dialog" class="fixed inset-0 z-50 dialog-overlay flex items-center justify-center p-4 opacity-0 pointer-events-none transition-opacity duration-300">
        <!-- ... existing new repo dialog ... -->
    </div>
    
    <!-- 上传文件对话框 -->
    <div id="upload-dialog" class="fixed inset-0 z-50 dialog-overlay flex items-center justify-center p-4 opacity-0 pointer-events-none transition-opacity duration-300">
        <!-- ... existing upload dialog ... -->
    </div>
    
    <!-- 静态网站配置对话框 -->
    <div id="static-site-dialog" class="fixed inset-0 z-50 dialog-overlay flex items-center justify-center p-4 opacity-0 pointer-events-none transition-opacity duration-300">
        <div id="static-site-content" class="dialog-content p-6 rounded-xl w-full max-w-md transform scale-90 transition-transform duration-300">
            <h3 id="static-site-title" class="text-xl font-bold mb-4">静态网站配置</h3>
            
            <div class="mb-4">
                <label class="block text-gray-700 mb-2 font-medium">分支</label>
                <select id="pages-branch" class="glass-input mb-1">
                    <option value="main">main</option>
                    <option value="master">master</option>
                    <option value="gh-pages">gh-pages</option>
                </select>
            </div>
            
            <div class="mb-4">
                <label class="block text-gray-700 mb-2 font-medium">目录</label>
                <select id="pages-folder" class="glass-input mb-1">
                    <option value="/">根目录</option>
                    <option value="/docs">docs 文件夹</option>
                </select>
            </div>
            
            <div id="pages-status" class="mb-4 hidden">
                <div class="flex items-center">
                    <i class="fas fa-circle text-green-500 mr-2"></i>
                    <span class="font-medium">网站已启用</span>
                </div>
                <div class="mt-2">
                    <span class="text-sm">访问地址: </span>
                    <a id="pages-url" href="#" target="_blank" class="text-blue-500 text-sm hover:underline"></a>
                </div>
            </div>
            
            <div id="static-site-buttons" class="flex justify-end gap-3">
                <button id="static-site-cancel" class="glass-btn px-4 py-2">取消</button>
                <button id="static-site-enable" class="glass-btn glass-btn-primary px-4 py-2">启用</button>
            </div>
        </div>
    </div>
    
    <!-- 上下文菜单 -->
    <div id="context-menu" class="context-menu">
        <!-- ... existing context menu items ... -->
        <div id="context-enable-pages" class="context-menu-item">
            <i class="fas fa-globe text-green-500"></i>
            <span>启用静态网站</span>
        </div>
    </div>
    
    <script>
        // 全局状态
        let currentRepo = '';
        let currentPath = '';
        let currentFiles = [];
        let githubToken = '';
        let fileToDelete = null;
        let selectedFiles = new Set();
        let contextMenuTarget = null;
        let currentUser = null;
        
        // DOM 元素
        const staticSiteBtn = document.getElementById('static-site-btn');
        const contextEnablePages = document.getElementById('context-enable-pages');
        const staticSiteDialog = document.getElementById('static-site-dialog');
        const pagesBranch = document.getElementById('pages-branch');
        const pagesFolder = document.getElementById('pages-folder');
        const pagesStatus = document.getElementById('pages-status');
        const pagesUrl = document.getElementById('pages-url');
        const staticSiteEnable = document.getElementById('static-site-enable');
        const staticSiteCancel = document.getElementById('static-site-cancel');

        // 初始化
        document.addEventListener('DOMContentLoaded', () => {
            // ... existing initialization code ...
            
            // 静态网站按钮事件
            staticSiteBtn.addEventListener('click', () => {
                showStaticSiteDialog();
            });

            contextEnablePages.addEventListener('click', () => {
                if (contextMenuTarget) {
                    showStaticSiteDialog(contextMenuTarget);
                }
                hideContextMenu();
            });

            staticSiteEnable.addEventListener('click', () => {
                enableGitHubPages();
            });

            staticSiteCancel.addEventListener('click', () => {
                hideStaticSiteDialog();
            });

            staticSiteDialog.addEventListener('click', (e) => {
                if (e.target === staticSiteDialog) {
                    hideStaticSiteDialog();
                }
            });
        });

        // 在 renderFileList 函数中添加（保持原有函数，添加以下代码）
        function renderFileList(items) {
            // ... existing renderFileList code ...
            
            // 检查是否有index.html文件
            if (currentRepo && currentFiles.some(file => file.name.toLowerCase() === 'index.html')) {
                staticSiteBtn.classList.remove('hidden');
            } else {
                staticSiteBtn.classList.add('hidden');
            }
            
            // ... rest of existing renderFileList code ...
        }

        // 在上下文菜单显示逻辑中添加（保持原有函数，添加以下代码）
        function showContextMenu(e, fileInfo) {
            // ... existing showContextMenu code ...
            
            // 根据文件类型显示/隐藏菜单项
            contextEnablePages.style.display = (fileInfo.type === 'repo' || 
                                             (fileInfo.type === 'dir' && fileInfo.name.toLowerCase() === 'docs')) ? 'flex' : 'none';
            
            // ... rest of existing showContextMenu code ...
        }

        // 静态网站相关函数
        function showStaticSiteDialog(repoInfo = null) {
            const targetRepo = repoInfo ? repoInfo.path : currentRepo;
            
            // 检查是否已启用Pages
            checkPagesStatus(targetRepo);
            
            staticSiteDialog.classList.add('opacity-100', 'pointer-events-auto');
            document.getElementById('static-site-content').classList.add('scale-100');
            document.getElementById('static-site-content').classList.remove('scale-90');
        }

        function hideStaticSiteDialog() {
            staticSiteDialog.classList.remove('opacity-100', 'pointer-events-auto');
            document.getElementById('static-site-content').classList.add('scale-90');
            document.getElementById('static-site-content').classList.remove('scale-100');
        }

        async function checkPagesStatus(repo) {
            try {
                const [owner, repoName] = repo.split('/');
                const response = await fetch(`https://api.github.com/repos/${owner}/${repoName}/pages`, {
                    headers: {
                        'Authorization': `token ${githubToken}`,
                        'Accept': 'application/vnd.github.v3+json'
                    }
                });
                
                if (response.ok) {
                    const data = await response.json();
                    if (data.status === 'built' || data.status === 'building') {
                        pagesStatus.classList.remove('hidden');
                        staticSiteEnable.classList.add('hidden');
                        pagesUrl.href = data.html_url;
                        pagesUrl.textContent = data.html_url;
                        
                        // 设置当前配置
                        pagesBranch.value = data.source.branch;
                        pagesFolder.value = data.source.path === '/docs' ? '/docs' : '/';
                    } else {
                        pagesStatus.classList.add('hidden');
                        staticSiteEnable.classList.remove('hidden');
                    }
                } else {
                    pagesStatus.classList.add('hidden');
                    staticSiteEnable.classList.remove('hidden');
                }
            } catch (error) {
                console.error('检查Pages状态错误:', error);
                pagesStatus.classList.add('hidden');
                staticSiteEnable.classList.remove('hidden');
            }
        }

        async function enableGitHubPages() {
            try {
                const [owner, repoName] = currentRepo.split('/');
                const branch = pagesBranch.value;
                const path = pagesFolder.value === '/docs' ? '/docs' : '/';
                
                const response = await fetch(`https://api.github.com/repos/${owner}/${repoName}/pages`, {
                    method: 'POST',
                    headers: {
                        'Authorization': `token ${githubToken}`,
                        'Accept': 'application/vnd.github.v3+json',
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify({
                        source: {
                            branch: branch,
                            path: path
                        }
                    })
                });
                
                if (response.ok) {
                    showToast('静态网站已启用，构建可能需要几分钟');
                    hideStaticSiteDialog();
                    
                    // 检查构建状态
                    setTimeout(() => {
                        checkPagesStatus(currentRepo);
                    }, 5000);
                } else {
                    const errorData = await response.json();
                    throw new Error(errorData.message || '启用静态网站失败');
                }
            } catch (error) {
                console.error('启用静态网站错误:', error);
                showToast('启用静态网站失败: ' + error.message);
            }
        }

        // ... rest of existing JavaScript code ...
    </script>
</body>
</html>